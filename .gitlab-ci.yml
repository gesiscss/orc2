include:
  - local: bot/mybinder.org/.gitlab-ci.yml

Build container with Kubernetes and git-crypt:
  stage: build
  rules:
    - if: ($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main'
      changes:
        - Dockerfile
  image: docker-private.gesis.intra/gesis/dc:5.7
  services:
    - name:  docker-private.gesis.intra/gesis/dind:5.5
      alias: docker
  dependencies: []
  script:
    - docker build --no-cache --pull --target kubernetes -t docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/k8s:latest .
    - docker push docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/k8s:latest

Build container with Python for test:
  stage: build
  rules:
    - if: ($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main'
      changes:
        - Dockerfile
        - test/env.yaml
  image: docker-private.gesis.intra/gesis/dc:5.7
  services:
    - name:  docker-private.gesis.intra/gesis/dind:5.5
      alias: docker
  dependencies: []
  script:
    - docker build --no-cache --pull --target test -t docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/test:latest .
    - docker push docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/test:latest

gesis ansible lint:
  stage: test
  rules:
    - if: (($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main') || $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - ansible/**/*
  image: 
    name: pipelinecomponents/ansible-lint
    entrypoint: [""]
  dependencies: []
  script:
    - ansible-lint --version
    - ansible-lint --show-relpath ansible

gesis ansible deploy:
  tags:
    - notebooks_gesis_org
  stage: deploy
  rules:
    - if: ($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main'
      changes:
        - ansible/**/*
        - nginx/**/*
  script:
    - echo $ANSIBLE_VAULT > ansible/.ansible-vault-password-file
    - ansible --version
    - ansible-playbook --vault-password-file ansible/.ansible-vault-password-file --extra-vars @ansible/vault/prometheus.yml --extra-vars ansible_become_password=${ANSIBLE_BECOME_PASSWORD} --inventory ansible/inventories/production ansible/orc2.yml

gesis helm lint:
  stage: test
  rules:
    - if: (($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main') || $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - helm/**/*
  image: 
    name: docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/k8s:latest
    entrypoint: [""]
  dependencies: []
  script:
    - helm version
    - helm dependency update ./helm/charts/gesis
    - helm lint ./helm/charts/gesis
    - helm template gesis ./helm/charts/gesis > gesis.helm.chart.yaml

gesis helm deploy:
  stage: deploy
  rules:
    - if: ($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main'
      changes:
        - helm/**/*
  image:
    name: docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/k8s:latest
    entrypoint: ['']
  dependencies: []
  script:
    - cat $git_crypt_secret_key | base64 -d > git_crypt_secret_key
    - git-crypt unlock git_crypt_secret_key
    - kubectl config use-context ilcm/orc2:kubernetes
    - helm version
    - helm dependency update ./helm/charts/gesis
    - |
      helm upgrade --cleanup-on-fail \
      --install binderhub ./helm/charts/gesis \
      --namespace=gesis \
      --create-namespace \
      -f ./helm/config/prod.yaml \
      -f ./helm/config/_secret-prod.yaml \
      -f ./helm/config/common/_secret-mybinder.org-common.yaml

Test script lint:
  stage: test
  rules:
    - if: (($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main') || $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - test/**/*
  image: 
    name: docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/test:latest
  dependencies: []
  script:
    - black --check test
    - pylint test/*.py

Test script run:
  stage: deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $GITLAB_CI_SCHEDULE_NAME == 'check-health'
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - test/**/*
  image: 
    name: docker-private-snapshots.gesis.intra/gesis/ilcm/orc2/test:latest
  dependencies: []
  script:
    - pytest --binder-url https://notebooks.gesis.org/binder/ --hub-url https://notebooks.gesis.org/binder/jupyter/ test

pages:
  stage: build
  rules:
    - if: ($CI_PIPELINE_SOURCE != "schedule") && $CI_COMMIT_BRANCH == 'main'
      changes:
        - docs/**/*
  image: docker-private-snapshots.gesis.intra/gesis/methods-hub/quarto:latest
  dependencies: []
  script:
    - quarto check
    - quarto render docs -t html --output-dir public
    - mv docs/public .
  artifacts:
    paths:
      - public


